<div
    id="graphOptions"
    x-data="graphOptions"
    x-init="
        (() => {
            const includeTransAllowed = $el.dataset.showIncludeTrans !== 'false';
            const phenotypeAllowed = $el.dataset.showPhenotype !== 'false';
            $store.graphOptionStore.showIncludeTransOption = includeTransAllowed;
            $store.graphOptionStore.showPhenotypeOption = phenotypeAllowed;
            if (!includeTransAllowed) {
                includeTrans = false;
                $store.graphOptionStore.includeTrans = false;
            }
            if (!phenotypeAllowed && traitType === 'phenotype') {
                traitType = 'all';
                $store.graphOptionStore.traitType = 'all';
            }
        })()
    "
>
    <b>Graph Options <a href="faq.html#graph-options" target="_blank">ⓘ</a></b>
    <br />
    <span class="is-size-7">Study P-value: <span x-text="Number(pValue).toExponential()"></span></span> <br />
    <input
        class="slider is-four-fifths mt-0 mb-0"
        x-model="pValueIndex"
        @input="updatePValue()"
        type="range"
        step="1"
        min="0"
        max="7"
    />
    <hr class="divider mt-0 mb-0" />

    <template x-if="$store.graphOptionStore.showIncludeTransOption">
        <div>
            <label class="checkbox mt-1 is-size-7">
                <input
                    @change="$store.graphOptionStore.includeTrans = includeTrans"
                    x-model="includeTrans"
                    type="checkbox"
                />
                Include Trans Markers
            </label>
            <br />
            <hr class="divider mt-0 mb-0" />
        </div>
    </template>

    <!-- Trait Type Selection -->
    <span class="is-size-7 has-text-weight-bold">Trait Types</span>
    <div class="ml-4">
        <div>
            <label class="radio is-size-7">
                <input
                    type="radio"
                    name="traitType"
                    value="all"
                    x-model="traitType"
                    @change="$store.graphOptionStore.traitType = traitType"
                />
                <span>All Traits</span>
            </label>
        </div>
        <div>
            <label
                class="radio is-size-7"
                :class="{ 'has-text-grey-light': Object.entries($store.graphOptionStore.categories).some(([k,v]) => typeof v === 'object' ? Object.values(v).some(Boolean) : v === true) }"
            >
                <input
                    type="radio"
                    name="traitType"
                    value="molecular"
                    x-model="traitType"
                    :disabled="Object.entries($store.graphOptionStore.categories).some(([k,v]) => typeof v === 'object' ? Object.values(v).some(Boolean) : v === true)"
                    @change="$store.graphOptionStore.traitType = traitType"
                />
                <span>Molecular Only</span>
            </label>
        </div>
        <template x-if="$store.graphOptionStore.showPhenotypeOption">
            <div>
                <label class="radio is-size-7">
                    <input
                        type="radio"
                        name="traitType"
                        value="phenotype"
                        x-model="traitType"
                        @change="$store.graphOptionStore.traitType = traitType"
                    />
                    <span>Phenotype Only</span>
                </label>
            </div>
        </template>
    </div>
    <hr class="divider mt-0 mb-0" />

    <!-- Categories Section -->
    <span class="is-size-7 has-text-weight-bold">Trait Categories</span>
    <div class="ml-0" x-data="{ expanded: {} }">
        <template x-for="category in Object.keys($store.graphOptionStore.categories)" :key="category">
            <div class="mb-1">
                <!-- Parent row -->
                <div class="is-flex is-align-items-center">
                    <div class="mr-0 ml-0" style="width: 16px">
                        <button
                            class="button is-ghost is-small p-0"
                            x-show="typeof $store.graphOptionStore.categories[category] === 'object'"
                            @click.prevent="expanded[category] = !expanded[category]"
                            :aria-expanded="expanded[category] ? 'true' : 'false'"
                            title="Show subcategories"
                        >
                            <span x-text="expanded[category] ? '▾' : '▸'"></span>
                        </button>
                    </div>
                    <label
                        class="checkbox is-size-7 mr-2"
                        :class="{ 'has-text-grey-light': $store.graphOptionStore.traitType === 'molecular' }"
                    >
                        <template x-if="typeof $store.graphOptionStore.categories[category] === 'object'">
                            <input
                                type="checkbox"
                                :disabled="$store.graphOptionStore.traitType === 'molecular'"
                                :checked="Object.values($store.graphOptionStore.categories[category]).every(v => v === true)"
                                @change="
                                    const checked = $event.target.checked;
                                    Object.keys($store.graphOptionStore.categories[category]).forEach(k => {
                                        $store.graphOptionStore.categories[category][k] = checked;
                                    });
                                    if ($store.graphOptionStore.traitType === 'molecular') {
                                        $store.graphOptionStore.traitType = 'all';
                                    }
                                "
                            />
                        </template>
                        <template x-if="typeof $store.graphOptionStore.categories[category] !== 'object'">
                            <input
                                type="checkbox"
                                :checked="$store.graphOptionStore.categories[category]"
                                :disabled="$store.graphOptionStore.traitType === 'molecular'"
                                @change="
                                    $store.graphOptionStore.categories[category] = $event.target.checked;
                                    if ($store.graphOptionStore.traitType === 'molecular') {
                                        $store.graphOptionStore.traitType = 'all';
                                    }
                                "
                            />
                        </template>
                        <span x-text="category"></span>
                    </label>
                </div>

                <!-- Children list -->
                <div
                    class="ml-4 mt-1"
                    x-show="expanded[category] && typeof $store.graphOptionStore.categories[category] === 'object'"
                >
                    <template x-for="subCat in Object.keys($store.graphOptionStore.categories[category])" :key="subCat">
                        <div>
                            <label
                                class="checkbox is-size-7"
                                :class="{ 'has-text-grey-light': $store.graphOptionStore.traitType === 'molecular' }"
                            >
                                <input
                                    type="checkbox"
                                    :checked="$store.graphOptionStore.categories[category][subCat]"
                                    :disabled="$store.graphOptionStore.traitType === 'molecular'"
                                    @change="
                                        $store.graphOptionStore.categories[category][subCat] = $event.target.checked;
                                        if ($store.graphOptionStore.traitType === 'molecular') {
                                            $store.graphOptionStore.traitType = 'all';
                                        }
                                    "
                                />
                                <span x-text="subCat"></span>
                            </label>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>
</div>
